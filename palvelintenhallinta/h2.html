<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <title>Palvelinten hallinta</title>
    </head>
    <body>
        <nav class="nav nav-tabs">
            <a class="nav-link" href="index.html">Etusivu</a>
            <a class="nav-link" href="h1.html">H1</a>
            <a class="nav-link" active>H2</a>
            <a class="nav-link" href="h3.md>H3</a>
            <a class="nav-link" href="h4.md">H4</a>
            <a class="nav-link" href="h5.md">H5</a>
            <a class="nav-link" href="h6.md">H6</a>
            <a class="nav-link" href="h7.md>H7</a>
        </nav>
        <div class="jumbotron" style="padding-top: 20px;">           
            <h1>Harjoitus H2 - package-file-service</h1>

            <div class="container" style="padding-top: 20px;">
                <div class="row">
                    <div class="col-3">Nimi</div>
                    <div class="col">Sanna Jyrinki</div>
                </div>
                <div class="row">
                    <div class="col-3">Oppilaitos</div>
                    <div class="col">Haaga-Helian ammattikorkeakoulu</div>
                </div>
                <div class="row">
                    <div class="col-3">Kurssi</div>
                    <div class="col">
                        <a href="https://terokarvinen.com/2021/configuration-management-systems-2022-spring/">Palvelinten hallinta ICT4TN022-3015</a>
                    </div>
                </div>
                <div class="row">
                    <div class="col-3">Opettaja</div>
                    <div class="col">Tero Karvinen</div>
                </div>
            </div>
            <div class="container" style="padding-top: 20px; padding-bottom: 20px;">
                <div class="row">
                    <div class="col-3">Tietokoneena</div>
                    <div class="col">AMD Ryzen 5 PRO 4650U with Radeon Graphics 2.10 GHz, RAM 16GB</div>
                </div>
                <div class="row">
                    <div class="col-3">Käyttöjärjestelmä</div>
                    <div class="col">Windows 11 Pro, Versio 21H2</div>
                </div>
                <div class="row">
                    <div class="col-3">Linux</div>
                    <div class="col">Oracle Virtual Box 6.1,  Debian 11.3</div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Pikalinkit</h5>
                    <ul>
                    <li><a href="#z">Tehtävä z</a></li>
                    <li><a href="#a">Tehtävä a</a></li>
                    <li><a href="#b">Tehtävä b</a></li>
                    <li><a href="#c">Tehtävä c</a></li>
                    </ul>

                    <h5 class="card-title">Lähteet</h5>
                    <p>Karvinen 2008: Install Apache Web Server on Ubuntu.
                        Luettavissa 
                        <a href="https://terokarvinen.com/2008/05/02/install-apache-web-server-on-ubuntu-4/">
                            https://terokarvinen.com/2008/05/02/install-apache-web-server-on-ubuntu-4/</a>.
                        Luettu 10.4.2022.
                    </p>
                    <p>Karvinen 2018a: Apache User Homepages Automatically – Salt Package-File-Service Example.
                        Luettavissa 
                        <a href="https://terokarvinen.com//2018/apache-user-homepages-automatically-salt-package-file-service-example/">
                            https://terokarvinen.com//2018/apache-user-homepages-automatically-salt-package-file-service-example/</a>.
                        Luettu 10.4.2022.
                    </p>
                    <p>Karvinen 2018b: Pkg-File-Service – Control Daemons with Salt – Change SSH Server Port.
                        Luettavissa 
                        <a href="https://terokarvinen.com//2018/pkg-file-service-control-daemons-with-salt-change-ssh-server-port/">
                            https://terokarvinen.com//2018/pkg-file-service-control-daemons-with-salt-change-ssh-server-port/</a>.
                        Luettu 10.4.2022.
                    </p>

                    <p>SaltStack contributors. 2016. SaltStack Configuration Management, Introduction.
                        Luettavissa 
                        <a href="https://docs.saltproject.io/en/getstarted/config/index.html">
                            https://docs.saltproject.io/en/getstarted/config/index.html</a>.
                        Luettu 10.4.2022.
                    </p>
                    <p>SaltStack contributors. 2016. SaltStack Configuration Management, Function.
                        Luettavissa 
                        <a href="https://docs.saltproject.io/en/getstarted/config/functions.html">
                            https://docs.saltproject.io/en/getstarted/config/functions.html</a>.
                        Luettu 10.4.2022.
                    </p>
                    <p>SaltStack contributors. 2016. SaltStack Configuration Management, Manage Files.
                        Luettavissa 
                        <a href="https://docs.saltproject.io/en/getstarted/config/files.html">
                            https://docs.saltproject.io/en/getstarted/config/files.html</a>.
                        Luettu 10.4.2022.
                    </p>
                    <p>SaltStack contributors 2022: Salt system architecture.
                        Luettavissa 
                        <a href="https://docs.saltproject.io/en/latest/topics/salt_system_architecture.html">
                            https://docs.saltproject.io/en/latest/topics/salt_system_architecture.html</a>.
                        Luettu 10.4.2022.
                    </p>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title" id="z">Tehtävä z, Lue ja tiivistä, su 10.4.2022 9:24-12:50</h5>
                    <p></p>

                    <h6 class="card-subtitle mb-2 text-muted">
                        <a href="https://docs.saltproject.io/en/getstarted/config/index.html">
                            SaltStack contributors 2016: SaltStack Configuration Management, Introduction</a>
                    </h6>
                    <ul>
                        <li>SaltStackin konfiguraation hallinnan oppaan johdantosivu</li>
                        <li>SaltStackin konfiguraation hallinnan avulla hallitset sovellusten, tiedostojen, konfiguraatioiden asennukset ja muutokset</li>
                        <li>Systeemi tunnistaa automaattisesti tarvitaanko muutoksia järjestelmään vai ei, ja suorittaa vain muutokset</li>
                    </ul>

                    <h6 class="card-subtitle mb-2 text-muted">
                        <a href="https://docs.saltproject.io/en/getstarted/config/functions.html">
                            SaltStack contributors 2016: SaltStack Configuration Management, Functions</a>
                    </h6>
                    <ul>
                        <li>Opas Saltin tilafunktioihin</li>
                        <li>Tilafunktioiden avulla konfuguroit sovellusasennuksia, luot käyttäjiä, jaat tiedostoja ym.</li>
                        <li>Salt tiloja kuvataan yaml:lla, jonka syntaksi esitellään</li>
                        <li>Paketin asennus/poisto - pkg.installed/removed</li>
                        <li>Hakemiston luonti -  file.directory</li>
                        <li>Demonin käynnistys - service.running</li>
                        <li>Demonin käynnistys kun systeemi bootataan - enable attribuutti</li>
                        <li>Git repon lataus - git.latest</li>
                        <li>Käyttäjän lisääminen - user.present</li>
                        <li>Hostin osoite - host.present</li>
                        <li>Suoritettavien funktioiden kutsuminen - module.run, nämä ajetaan aina kun kutsutaan, kun taas tilafunktiot ajetaan vain jos tila muuttunut</li>
                        <li>test=True näyttää muutokset tilafunktioita kutsuttaessa</li>
                    </ul>

                    <h6 class="card-subtitle mb-2 text-muted">
                        <a href="https://docs.saltproject.io/en/getstarted/config/files.html">
                            SaltStack contributors 2016: SaltStack Configuration Management, Manage Files</a>
                    </h6>
                    <ul>
                        <li>SALT:// - sls tiedostossa voidaan viitata /src/salt hakemiston alla oleviin tiedostoihin suhteellisella polulla laittamalla eteen salt://</li>
                        <li>Tiedoston luonti - fil.managed, rivin lisäys - file.append</li>
                        <li>Hakemiston kopioiminen (sisältöineen) - file.recurse</li>
                    </ul>

                    <h6 class="card-subtitle mb-2 text-muted">
                        <a href="https://terokarvinen.com/2008/05/02/install-apache-web-server-on-ubuntu-4/">
                            Karvinen 2008: Install Apache Web Server on Ubuntu</a>
                    </h6>
                    <ul>
                        <li>Ohje apachen asennukseen Linuxille</li>
                        <li>Opastaa myös käyttäjän kotisivun tekemisen apacheen ja sen testaamiseen</li>
                    </ul>

                    <h6 class="card-subtitle mb-2 text-muted">
                        <a href="https://terokarvinen.com//2018/apache-user-homepages-automatically-salt-package-file-service-example/">
                            Karvinen 2018a: Apache User Homepages Automatically – Salt Package-File-Service Example</a>
                    </h6>
                    <ul>
                        <li>Esimerkki kuinka saltin avulla saa automatisoitua kotisivujen luonnin</li>
                        <li>Ensin luodaan sivut manuaalisesti</li>
                        <li>Luodaan init.sls tarvittavat asiat</li>
                        <li>Muokataan vielä init.sls, siten että konfiguraatiot syntyvät tiedostoista</li>
                    </ul>

                    <h6 class="card-subtitle mb-2 text-muted">
                        <a href="https://terokarvinen.com//2018/pkg-file-service-control-daemons-with-salt-change-ssh-server-port/">
                            Karvinen 2018b: Pkg-File-Service – Control Daemons with Salt – Change SSH Server Port</a>
                    </h6>
                    <ul>
                        <li>Ohje, miten ssh demonin portti muutetaan saltilla</li>
                        <li>Tehdään sls-tiedosto, joka asentaa ssh:n ja käynnistää demonin kun konfiguraatio-tiedosto muuttuu</li>
                        <li>saltin juurihakemistoon kopioidaan ssh:n konfiguraatiotiedosto, jossa portti on määritelty halutuksi</li>
                    </ul>

                    <h6 class="card-subtitle mb-2 text-muted">
                        <a href="https://docs.saltproject.io/en/latest/topics/salt_system_architecture.html">
                            SaltStack contributors 2022: Salt system architecture</a>
                    </h6>
                    <ul>
                        <li>Sivu esittelee saltin herra-orja arkkitehtuurin</li>
                        <li>yksi master, useita orjia, herra käskyttää orjia, ja orjakoneella ajetaan käskyt</li>
                        <li>esitellään useita käsitteitä kuten target, grains, states, top file, high state, pillar, beacons, reactors, runners ja orchestration</li>
                        <li>Esim. top filessa (top.sls) määritellään mitä käskyjä ajetaan milläkin orjakoneella</li>
                    </ul>

                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title" id="a">Tehtävä a, Oletussivu su 10.4.2022 16:00-</h5>

                <p>Asennan manuaalisesti vielä apachen (koska koneellani ei vielä ollut apachea)
                <pre>
                    sudo apt-get install -y apache2
                </pre>
                </p>
                <p>Selain ei näytä vielä localhostissa mitään, joten käynnistän apachen uudelleen
                <pre>
                    sudo systemctl restart apache2
                </pre>
                </p>
                <p>Nyt localhostissa näkyy apachen testisivu, eli asennus onnistui</p>
                <p>
                    <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2a_2.PNG" alt="Responsive image">
                </p>
                </div>

                <p>Tehdään hakemisto saltille ja apachen init.sls:lle
                <pre>
                    sudo mkdir /srv/salt/apache
                </pre>
                </p>
                
                <p>Tehdään /srv/salt/apache/init.sls.
                    Säädetään siinä salt asentamaan apache (pkg.installed) ja korvaamaan testisivu saltin /srv/salt/apache hakemiston 
                    default-index.html tiedostolla. Säädetään myös apache käynnistymään.
                </p>
                <p>
                    <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2a_3.PNG" alt="Responsive image">
                </p>

                <p>Tehdään saltin juureen top.sls, joka hallinnoi eri tilojen ajoja orjille.
                    Säädetään top.sls salt suorittamaan tilan apache kaikille orjille (*)
                </p>
                <p>
                    <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2a_4.PNG" alt="Responsive image">
                </p>

                <p>Ajetaan saltin tilat</p>
                <p>
                    <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2a_5.PNG" alt="Responsive image">
                    <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2a_6.PNG" alt="Responsive image">
                </p>

                <p>Tulosteesta näkee, että on ajettu funktio file.managed, joka on korvannut apachen sivun
                    /var/www/html/index.html uudella sisällöllä, testataan vielä selaimella localhost osoitteessa, että
                siellä näkyy päivittynyt sivu. </p>
                <p>
                    <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2a_7.PNG" alt="Responsive image">
                </p>

            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title" id="b">Tehtävä b, Tri Kaaaos</h5>

                    <p>Ajetaan ensin salt tilat uudestaan ja nähdään, että mitään ei tapahdu, koska mitään 
                        muutoksia ei ole tehty
                    </p>
                    <p>
                        <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2b_1.PNG" alt="Responsive image">
                    </p>

                    <p>Sammutetaan apache ajamalla 'sudo systemctl stop apache2', jonka jälkeen curl localhostiin ei vastaa.
                    </p>
                    <p>
                        <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2b_2.PNG" alt="Responsive image">
                    </p>

                    <p>Ajetaan apache-tila uudestaan, ja nähdään, että salt on käynnistänyt apachen uudelleen (service.running).
                    </p>
                    <p>
                        <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2b_3.PNG" alt="Responsive image">
                    </p>

                    <p>Tarkistetaan curlilla, että nyt taas localhost vastaa.
                    </p>
                    <p>
                        <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2b_4.PNG" alt="Responsive image">
                    </p>

                    <p>Deletoidaan apachen testisivu. Curlilla havaitaan, että apache sinällään on
                        pystyssä, mutta koska testisivua index.html ei löydy, se palauttaa hakemistorakennesivun vastauksena.
                    </p>
                    <p>
                        <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2b_5.PNG" alt="Responsive image">
                    </p>

                    <p>Ajamalla tilat uudelleen, sivu kopioituu saltin konfiguroinneista uudelleen, ja localhost taas toimii kuten pitääkin.
                    </p>
                    <p>
                        <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2b_6.PNG" alt="Responsive image">
                    </p>

                    <p>Stopataan apache, poistetaan apache2 pakettien asennus, yritetään startata apache, ei tietenkään onnistu kun paketit puuttuu.
                        Ajetaan saltilla tilat uudelleen, ja sekä apache2 pakettien asennus, että apache2 starttaus tapahtuu uudelleen ja localhost taas toimii.
                    </p>
                    <p>
                        <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2b_7.PNG" alt="Responsive image">
                    </p>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title" id="c">Tehtävä c, Shh!</h5>

                    <p>Asennetaan ensin ssh manuaalisesti
                    <pre>
                        sudo apt-get -y install openssh-server
                    </pre>
                    </p>
                    <p>
                        Ssh asentui ja konfiguraatiotiedosto löytyy osoitteesta /etc/ssh/sshd-config
                    </p>
                    <p>
                        <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2c_1.PNG" alt="Responsive image">
                    </p>

                    <p>
                        Luodaan ssh:lle oma ssh-tila ja init.sls. 
                        Siinä salt asentaa openssh-server sovelluksen, 
                        kopioi konfiguraatiotiedoston saltin alta ja 
                        käynnistää serverin aina kun konfiguraatiomuutoksia tehdään.
                    </p>
                    <p>
                        <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2c_2.PNG" alt="Responsive image">
                    </p>

                    <p>
                        Lisätään ssh tila ajettavaksi top.sls tiedostoon
                    </p>
                    <p>
                        <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2c_3.PNG" alt="Responsive image">
                    </p>

                    <p>
                        Ajetaan saltin tilat, ssh käynnistyy, vielä ei muutettu porttia
                    </p>
                    <p>
                        <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2c_4.PNG" alt="Responsive image">
                    </p>

                    <p>
                        Testataan ssh:ta, jos porttia ei anneta, tai annetaan ssh:n oletusportti 22, homma toimii, muilla porteilla ei.
                    </p>
                    <p>
                        <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2c_5.PNG" alt="Responsive image">
                    </p>

                    <p>
                        Muokataan sshd_config tiedostoon portiksi 7373
                    <pre>
                        sudo micro sshd_config
                    </pre>
                    </p>
                    <p>
                        <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2c_6.PNG" alt="Responsive image">
                    </p>

                    <p>Ajetaan salt tilat, nyt konfiguraatiotiedosto kopioituu, koska siinä on muutos.
                        Lisäksi ssh demoni käynnistyy uudelleen.
                    </p>
                    <p>
                        <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2c_7.PNG" alt="Responsive image">
                    </p>

                    <p>Testataan, nyt kirjautumaan pääsee vain portissa 7373.
                    </p>
                    <p>
                        <img width="50%" style="border: solid 1px" class="card-img-left img-fluid" src="h2_images/h2c_8.PNG" alt="Responsive image">
                    </p>
                    
                </div>
            </div>

        </div>
            
    </body>
</html>
